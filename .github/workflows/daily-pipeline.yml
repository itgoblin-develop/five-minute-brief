name: Daily News Pipeline

on:
  # schedule 비활성화 — EC2 systemd 타이머로 직접 실행 (01:00 KST)
  # GitHub Actions runner에서는 EC2 DB/SSH 접근 불가하여 EC2 로컬 실행으로 전환
  # schedule:
  #   - cron: '0 16 * * *'
  workflow_dispatch:
    inputs:
      skip_crawl:
        description: 'Skip crawling (use existing data)'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Dry run (no DB loading)'
        required: false
        default: 'false'
        type: boolean
      date:
        description: 'Target date (YYYY-MM-DD, default: today KST)'
        required: false
        type: string

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: pipeline/requirements.txt

      - name: Setup Chrome & Chromedriver
        uses: nanasess/setup-chromedriver@v2

      - name: Install dependencies
        run: pip install -r pipeline/requirements.txt

      - name: Create .env file
        run: |
          cat > .env << 'ENVEOF'
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          ENVEOF

      - name: Determine run flags
        id: flags
        run: |
          FLAGS=""

          # Skip crawl
          if [ "${{ inputs.skip_crawl }}" = "true" ]; then
            FLAGS="$FLAGS --skip-crawl"
          fi

          # Dry run: explicit input OR no DB secrets configured
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            FLAGS="$FLAGS --dry-run"
          elif [ -z "${{ secrets.DB_HOST }}" ]; then
            echo "⚠️ DB secrets not configured, forcing --dry-run"
            FLAGS="$FLAGS --dry-run"
          fi

          # Date
          if [ -n "${{ inputs.date }}" ]; then
            FLAGS="$FLAGS --date ${{ inputs.date }}"
          fi

          echo "flags=$FLAGS" >> $GITHUB_OUTPUT

      - name: Run daily pipeline
        run: python pipeline/run_daily.py ${{ steps.flags.outputs.flags }}

      - name: Deploy thumbnails to EC2
        if: success() && !contains(steps.flags.outputs.flags, '--dry-run')
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "app/backend/public/thumbnails/"
          target: "~/five-minute-brief/"
          strip_components: 0
          overwrite: true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-output-${{ github.run_number }}
          path: |
            pipeline/daily_brief_*.json
            pipeline/reconstructed_*.json
            app/backend/public/thumbnails/
          retention-days: 14
          if-no-files-found: ignore

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Pipeline failed: ${date}`,
              body: `Daily pipeline failed.\n\nRun: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['pipeline', 'bug']
            });
